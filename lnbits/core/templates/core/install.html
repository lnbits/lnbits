{% extends "base.html" %} {% from "macros.jinja" import window_vars with context
%} {% block page %}
<div class="row q-col-gutter-md q-mb-md">
  <div class="col-sm-7 col-xs-6 mt-lg">
    <q-btn
      type="a"
      :href="['/extensions?usr=', g.user.id].join('')"
      color="primary unelevated mt-lg pt-lg"
      >Manage Extensions</q-btn
    >
  </div>
  <div class="col-sm-3 col-xs-6 q-ml-auto">
    <q-input v-model="searchTerm" label="Search extensions">
      <q-icon
        v-if="searchTerm !== ''"
        name="close"
        @click="searchTerm = ''"
        class="cursor-pointer q-mt-lg"
      />
    </q-input>
  </div>
</div>

<div class="row q-col-gutter-md">
  <div
    class="col-6"
    v-for="extension in filteredExtensions"
    :key="extension.id"
  >
    <q-card>
      <q-card-section>
        <q-icon
          :name="extension.icon"
          color="grey-5"
          style="font-size: 4rem"
        ></q-icon>
        {% raw %}
        <h5 class="q-mt-lg q-mb-xs">{{ extension.name }}</h5>
        <small>{{ extension.shortDescription }} </small>{% endraw %}
      </q-card-section>
      <q-separator></q-separator>
      <q-card-actions>
        <div v-if="extension.isInstalled">
          <q-btn flat color="grey-5"> Uninstall</q-btn>
        </div>
        <q-btn v-else flat color="primary" @click="installExtension(extension)">
          Install</q-btn
        >
      </q-card-actions>
    </q-card>
  </div>
</div>
{% endblock %} {% block scripts %} {{ window_vars(user) }}
<script>
  new Vue({
    el: '#vue',
    data: function () {
      return {
        searchTerm: '',
        filteredExtensions: null
      }
    },
    watch: {
      searchTerm(term) {
        if (term !== '') {
          // Filter the extensions list
          function extensionNameContains(searchTerm) {
            return function (extension) {
              return (
                extension.name
                  .toLowerCase()
                  .includes(searchTerm.toLowerCase()) ||
                extension.shortDescription
                  ?.toLowerCase()
                  .includes(searchTerm.toLowerCase())
              )
            }
          }

          this.filteredExtensions = this.extensions.filter(
            extensionNameContains(term)
          )
        }
      }
    },
    methods: {
      installExtension: async function (extension) {
        console.log('### installExtension', extension)
        try {
          await LNbits.api.request(
            'POST',
            `/api/v1/extension/${extension.id}`,
            this.g.user.wallets[0].adminkey
          )
          extension.isInstalled = true
        } catch (error) {
          LNbits.utils.notifyApiError(error)
        }
      }
    },
    created: function () {
      this.extensions = JSON.parse('{{extensions | tojson | safe}}')
      this.filteredExtensions = this.extensions.concat([])
    },
    mixins: [windowMixin]
  })
</script>
{% endblock %}
