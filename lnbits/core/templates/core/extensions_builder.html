{% if not ajax %} {% extends "base.html" %} {% endif %}
<!---->
{% from "macros.jinja" import window_vars with context %}
<!---->
{% block scripts %} {{ window_vars(user) }}{% endblock %} {% block page %}

<div class="row">
  <div class="col-12">
    <q-stepper
      v-model="step"
      ref="stepper"
      color="primary"
      animated
      header-nav
      class="q-pt-sm"
    >
      <q-step
        :name="1"
        title="Describe"
        icon="info"
        :done="step > 1"
        style="min-height: 100px"
      >
        <div class="row q-col-gutter-md">
          <div class="col-12">
            <span class="text-h6">
              Tell us something about your extension:
            </span>
            <ul>
              <li>This is the first step, you can return and change it.</li>
              <li>
                The <code>`name`</code> and
                <code>`sort description`</code> fields are what the users will
                see when browsing the list of extensions.
              </li>
              <li>
                The <code>`id`</code> field is used internally and in the URL of
                your extension.
              </li>
            </ul>
          </div>

          <!-- todo: add icon -->

          <div class="col-12">
            <div>
              <q-btn
                color="primary"
                label="Upload Existing config"
                @click="$refs.extensionDataInput.click()"
                class="q-mb-md"
              />
              <input
                type="file"
                ref="extensionDataInput"
                accept="application/json"
                style="display: none"
                @change="onJsonDataInput"
              />
            </div>
          </div>
        </div>
        <q-separator class="q-mt-sm"></q-separator>
        <div class="row q-col-gutter-md q-mt-md">
          <div class="col-md-4 col-sm-12">
            <q-input
              filled
              v-model="extensionData.name"
              label="Extension Name"
              hint="The name of your extension"
            >
            </q-input>
          </div>
          <div class="col-md-4 col-sm-12">
            <q-input
              filled
              v-model="extensionData.id"
              label="Extension Id"
              hint="Lowercase letters, numbers, and underscores only (snake_case). This will be used in the URL."
            >
            </q-input>
          </div>
          <div class="col-md-4 col-sm-12">
            <q-input
              filled
              v-model="extensionData.short_description"
              label="Short Description"
              hint="A short description that is shown in the extension list."
            >
            </q-input>
          </div>
        </div>
        <div class="row q-mt-lg">
          <div class="col-12">
            <q-input
              filled
              v-model="extensionData.description"
              label="Description"
              hint="A detailed description of your extension."
              type="textarea"
              rows="3"
              maxlength="1000"
            >
            </q-input>
          </div>
        </div>
      </q-step>

      <q-step
        :name="2"
        title="Settings"
        icon="settings"
        :done="step > 2"
        style="min-height: 100px"
      >
        <div class="row q-col-gutter-md q-mt-md">
          <div class="col-md-8 col-sm-12">
            <q-img
              :src="'{{ static_url_for('static', 'images/builder/build_02.png') }}'"
            ></q-img>
          </div>
          <div class="col-md-4 col-sm-12">
            <q-toggle
              v-model="extensionData.settings_data.enabled"
              label="Generate Settings Fields"
              size="md"
              color="green"
            />
            <br />
            <ul>
              <li>Define what settings your extension will have.</li>
              <li>
                You can choose if each user has its own settings or if the
                settings are global (set by the admin).
              </li>
            </ul>
          </div>
        </div>

        <q-separator
          v-if="extensionData.settings_data.enabled"
          class="q-mt-sm"
        ></q-separator>
        <div v-if="extensionData.settings_data.enabled" class="row q-mt-lg">
          <div class="col-md-2 col-sm-12">
            <q-select
              filled
              dense
              emit-value
              map-options
              v-model="extensionData.settings_data.type"
              :options="settingsTypes"
            ></q-select>
          </div>
          <div class="col-md-10 col-sm-12 q-pt-sm">
            <q-badge
              v-if="extensionData.settings_data.type === 'user'"
              outline
              class="text-caption q-ml-md"
              >Each user can set its own settings for this extension.</q-badge
            >
            <q-badge v-else outline class="text-caption q-ml-md"
              >Settings are set by the admin and apply to all users of the
              extension</q-badge
            >
          </div>
        </div>
        <div v-if="extensionData.settings_data.enabled" class="row q-mt-lg">
          <div class="col-12">
            <lnbits-data-fields
              :fields="extensionData.settings_data.fields"
              :hide-advanced="true"
            ></lnbits-data-fields>
          </div>
        </div>
      </q-step>

      <q-step
        :name="3"
        :done="step > 3"
        title="Owner Data"
        icon="list"
        style="min-height: 100px"
      >
        <div class="row q-col-gutter-md q-mt-md">
          <div class="col-md-8 col-sm-12">
            <q-img
              :src="'{{ static_url_for('static', 'images/builder/build_03.png') }}'"
            ></q-img>
          </div>
          <div class="col-md-4 col-sm-12">
            <q-input
              v-model="extensionData.owner_data.name"
              filled
              label="Owner Table Name"
              hint="CamelCase name for the owner data table (e.g. Campaign, PoS, etc.)"
              class="q-mb-xl"
            >
            </q-input>

            <ul>
              <li>
                The owner of the extension manages this data. It can add, remove
                and update instances of it.
              </li>

              <li>
                Some fileds are present by default, like
                <code>created_at</code>, <code>updated_at</code> and
                <code>extra</code>.
              </li>
            </ul>
          </div>
        </div>

        <div class="row q-mt-lg">
          <div class="col-12">
            <lnbits-data-fields
              :fields="extensionData.owner_data.fields"
            ></lnbits-data-fields>
          </div>
        </div>
      </q-step>

      <q-step
        :name="4"
        :done="step > 4"
        title="Client Data"
        icon="blur_linear"
        style="min-height: 100px"
      >
        <div class="row q-col-gutter-md q-mt-md">
          <div class="col-md-8 col-sm-12">
            <q-img
              :src="'{{ static_url_for('static', 'images/builder/build_04.png') }}'"
            ></q-img>
          </div>
          <div class="col-md-4 col-sm-12">
            <q-toggle
              v-model="extensionData.client_data.enabled"
              label="Generate Client Table"
              disable
              size="md"
              color="green"
            />
            <br />
            <q-input
              v-if="extensionData.client_data.enabled"
              v-model="extensionData.client_data.name"
              filled
              label="Client Table Name"
              hint="CamelCase name for the client data table (e.g. Donation, Payment, etc.)"
              class="q-mb-xl"
            >
            </q-input>
            <ul>
              <li>
                This data is created by users of the extension. Usually when
                they submit a form or make a payment.
              </li>
              <li>
                The owner of the extension can view this data, but should not
                modify it.
              </li>
            </ul>
          </div>
        </div>
        <q-separator
          v-if="extensionData.client_data.enabled"
          class="q-mt-sm"
        ></q-separator>
        <div v-if="extensionData.client_data.enabled" class="row q-mt-lg">
          <div class="col-12">
            <lnbits-data-fields
              :fields="extensionData.client_data.fields"
            ></lnbits-data-fields>
          </div>
        </div>
      </q-step>

      <q-step
        :name="5"
        :done="step > 5"
        title="Public Pages"
        icon="link"
        style="min-height: 100px"
      >
        <div class="row q-col-gutter-md q-mt-md">
          <div class="col-md-8 col-sm-12">
            <q-img
              :src="'{{ static_url_for('static', 'images/builder/build_04.png') }}'"
            ></q-img>
          </div>
          <div class="col-md-4 col-sm-12 q-gutter-y-md">
            <q-toggle
              v-model="extensionData.public_page.has_public_page"
              label="Has Public Page"
              size="md"
              color="green"
            />
            <q-select
              filled
              dense
              emit-value
              map-options
              v-if="extensionData.public_page.has_public_page"
              v-model="extensionData.public_page.owner_data_fields.name"
              hint="The title field in the public page."
              :options="[''].concat(extensionData.owner_data.fields.map(f => f.name))"
            ></q-select>
            <q-select
              filled
              dense
              emit-value
              map-options
              hint="The description field in the public page."
              v-if="extensionData.public_page.has_public_page"
              v-model="extensionData.public_page.owner_data_fields.description"
              :options="[''].concat(extensionData.owner_data.fields.map(f => f.name))"
            ></q-select>
            <q-select
              filled
              dense
              emit-value
              map-options
              multiple
              clearable
              hint="Client fields that will be shown as inputs in the public page form."
              v-if="extensionData.public_page.has_public_page"
              v-model="extensionData.public_page.client_data_fields.public_inputs"
              :options="extensionData.client_data.fields.map(f => f.name)"
            ></q-select>
            <br />
            <q-toggle
              v-model="extensionData.public_page.action_fields.generate_action"
              label="Generate Action Button"
              hint="If enabled, a button will be shown to perform an action (e.g. create invoice, make payment, etc.)"
              size="md"
              color="green"
            />
            <q-select
              filled
              dense
              emit-value
              map-options
              v-if="extensionData.public_page.action_fields.generate_action"
              hint="The wallet where payments will be received."
              v-model="extensionData.public_page.action_fields.wallet_id"
              :options="extensionData.owner_data.fields.map(f => f.name)"
            ></q-select>
            <q-select
              filled
              dense
              emit-value
              map-options
              v-if="extensionData.public_page.action_fields.generate_action"
              hint="The currency field. Empty if you want to use sats."
              v-model="extensionData.public_page.action_fields.currency"
              :options="extensionData.owner_data.fields.map(f => f.name)"
            ></q-select>
            <q-select
              filled
              dense
              emit-value
              map-options
              v-if="extensionData.public_page.action_fields.generate_action"
              hint="The amount field."
              v-model="extensionData.public_page.action_fields.amount"
              :options="extensionData.client_data.fields.map(f => f.name)"
            ></q-select>
          </div>
        </div>
      </q-step>
      <q-step
        :name="6"
        :done="step > 6"
        title="Review"
        icon="how_to_reg"
        style="min-height: 100px"
      >
        This is how your extension will look like.
      </q-step>
      <q-step
        :name="7"
        :done="step > 7"
        title="Publish"
        icon="publish"
        style="min-height: 100px"
      >
        Admins can publish to this server.
        <br />
        Regular users can download the JSON config and upload it in their own
        servers.
        <br />
        <div class="row">
          <div class="col-md-4 col-sm-12 col-xs-12">
            <q-select
              filled
              dense
              emit-value
              map-options
              v-model="extensionData.stub_version"
              hint="The version of the extension stub. Make sure it is compatible with your LNbits install."
              :options="extensionStubVersions.map(f => f.version)"
            ></q-select>
          </div>
        </div>
        <div class="row q-mt-md">
          <div class="col-md-4 col-sm-12 col-xs-12">
            <q-btn
              @click="buildExtension(true)"
              color="primary"
              label="Build and Deploy (Admin Only)"
              class="q-ml-md full-width"
            />
          </div>
        </div>

        <div class="row q-mt-md">
          <div class="col-md-4 col-sm-12 col-xs-12">
            <q-btn
              @click="buildExtension(false)"
              outline
              color="gray"
              label="Download Extension Archive (Admin Only)"
              icon="download"
              class="q-ml-md full-width"
            />
          </div>
        </div>
      </q-step>

      <template v-slot:navigation>
        <q-separator></q-separator>
        <div class="row">
          <div class="col-md-6 col-sm-12 q-pl-md q-pt-md">
            <q-btn
              v-if="step == 1"
              label="Clear All Data"
              color="negative"
              @click="clearAllData"
            ></q-btn>
          </div>
          <div class="col-md-6 col-sm-12 q-pr-md q-pb-md">
            <q-stepper-navigation class="float-right">
              <q-btn
                v-if="step > 0"
                flat
                color="grey-8"
                class="q-mr-sm"
                @click="previousStep()"
                label="Back"
              />

              <q-btn
                v-if="step < 7"
                @click="nextStep()"
                color="primary"
                label="Next"
              ></q-btn>
              <q-btn
                v-else
                @click="exportJsonData()"
                color="primary"
                label="Export JSON Data"
              ></q-btn>
            </q-stepper-navigation>
          </div>
        </div>
      </template>
    </q-stepper>
  </div>
</div>
<div class="row q-col-gutter-md"></div>
{% endblock %}
