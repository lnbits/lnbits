{% extends "base.html" %} {% from "macros.jinja" import window_vars with context
%} {% block page %}

<div class="row q-col-gutter-md q-mb-md">
  <div class="col-sm-9 col-xs-12">
    <p class="text-h4 gt-sm">
      {%raw%}{{ $t('nix_package_installer') }}{%endraw%}
    </p>
  </div>
</div>

<div class="row q-col-gutter-md q-mb-md">
  <div class="col-12">
    <q-card>
      <div class="q-pa-xs">
        <div class="q-gutter-y-md">
          <q-tabs v-model="tab" active-color="primary" align="left">
            <q-tab
              name="packages"
              :label="$t('packages')"
              @update="val => tab = val.name"
            ></q-tab>
            <q-tab
              name="support_packages"
              :label="$t('support_packages')"
              @update="val => tab = val.name"
            ></q-tab>
            <q-tab
              name="config"
              :label="$t('config_file')"
              @update="val => tab = val.name"
            ></q-tab>
          </q-tabs>
        </div>
      </div>
    </q-card>
  </div>
</div>
<q-card class="no-border no-outline no-box-shadow">
  <q-form
    name="settings_form"
    id="settings_form"
    class="no-border no-outline no-box-shadow"
  >
    <q-tab-panels
      v-model="tab"
      animated
      class="bg-dark no-border no-outline no-box-shadow"
    >
      {% include "admin/_tab_install_packages.html" %}{% include
      "admin/_tab_install_support_packages.html" %} {% include
      "admin/_tab_install_config.html" %}
    </q-tab-panels>
  </q-form>
</q-card>

<q-dialog v-model="packageDialog.show" position="top">
  <q-card class="q-pa-lg" style="width: 800px; max-width: unset">
    <h6>Nix Configurations</h6>

    <div v-if="packageDialog.nixConfig" class="row q-mt-lg">
      <div class="col">
        <lnbits-dynamic-controls
          :options="packageDialog.nixConfig.options"
          v-model="packageDialog.nixData"
        ></lnbits-dynamic-controls>
      </div>
    </div>
    <div class="row q-mt-lg">
      <q-btn v-close-popup @click="updateConfig()" color="primary"
        >Update</q-btn
      >
      <q-btn v-close-popup flat color="grey" class="q-ml-auto">Cancel</q-btn>
    </div>
  </q-card>
</q-dialog>

{% endblock %} {% block scripts %} {{ window_vars(user) }}
<script src="/core/static/js/nix-utils.js"></script>
<script>
  new Vue({
    el: '#vue',
    mixins: [windowMixin],
    data: function () {
      return {
        tab: 'packages',
        packages: null,
        supportpackages: null,
        config: '',
        configAr: [],
        packageDialog: {
          show: false,
          packageId: null,
          nixConfig: null,
          nixData: null
        }
      }
    },
    computed: {},
    methods: {
      async showPackageConfigDialog(packageId) {
        this.packageDialog = {
          show: true,
          packageId,
          nixConfig: null,
          nixData: null
        }
        await this.getNixConfig(packageId)
      },
      getPackages() {
        self = this
        LNbits.api.request('GET', '/admin/api/v1/apps').then(response => {
          var packages = JSON.stringify(response.data.packages)
          this.packages = JSON.parse(packages)
          for (var i = 0; i < this.packages.length; i++) {
            const flake = this.packages[i].repo.trim().split('/')
            const flakeStr = './' + flake[flake.length - 1]
            if (self.configAr.includes(flakeStr)) {
              this.packages[i].installed = true
            }
          }
          // console.log(self.configAr)

          var supportpackages = JSON.stringify(response.data.support_packages)
          this.supportpackages = JSON.parse(supportpackages)
          for (var i = 0; i < this.supportpackages.length; i++) {
            const flake = this.supportpackages[i].repo.trim().split('/')
            const flakeStr = './' + flake[flake.length - 1]
            if (self.configAr.includes(flakeStr)) {
              this.supportpackages[i].installed = true
            }
          }
          // console.log(self.configAr)
        })
      },
      async getNixConfig(packageId) {
        try {
          const {data} = await LNbits.api.request(
            'GET',
            `/admin/api/v1/config/${packageId}`,
            this.g.user.wallets[0].adminkey
          )
          this.packageDialog.nixConfig = nixConfigToJson(data.config)
          this.packageDialog.nixData = data.data || {}
        } catch (error) {
          console.warn(error)
          LNbits.utils.notifyApiError(error)
        }
      },
      getConfig() {
        self = this
        LNbits.api.request('GET', '/admin/api/v1/config').then(response => {
          self.config = response.data
          self.configAr = self.config.split(/\r\n|\r|\n/).map(function (item) {
            return item.trim()
          })
        })
      },
      async updateConfig() {
        try {
          const {data} = await LNbits.api.request(
            'PUT',
            `/admin/api/v1/config/${this.packageDialog.packageId}`,
            this.g.user.wallets[0].adminkey,
            {
              config: JSON.stringify(this.packageDialog.nixData, null, 2)
            }
          )
          this.$q.notify({
            message: 'Nix configuration updated',
            type: 'positive',
            timeout: 5
          })
        } catch (error) {
          console.warn(error)
          LNbits.utils.notifyApiError(error)
        }
      }
    },
    created() {
      this.getPackages()
      this.getConfig()
    }
  })
</script>
{% endblock %}
