{% extends "base.html" %} {% from "macros.jinja" import window_vars with context
%} {% block page %}

<h3 class="q-my-none">Admin</h3>
<p></p>
<!--
  Forked from:
  https://quasar.dev/vue-components/form#Example--Basic
-->
<div class="row">
  <div class="col-8">
    <q-card class="q-mr-md">
      <q-form
        @submit="LaunchLNbits"
        @reset="cancelAdmin"
        class="q-px-md q-py-md"
      >
        <h6 class="q-my-md">Settings</h6>
        <div class="row">
          <div class="col">
            <q-input
              filled
              v-model="data.admin.site_title"
              label="Site title"
              class="q-pr-md"
              hint="To replace the default 'LNbits' name and tagline"
            ></q-input>
          </div>
          <div class="col">
            <q-input
              filled
              v-model="data.admin.tagline"
              label="Tagline"
            ></q-input>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <q-input
              filled
              class="q-pr-md"
              type="number"
              v-model="data.admin.service_fee"
              label="Sevice fee"
              hint="What percentage to charge per transaction *default 0"
            ></q-input>
          </div>
          <div class="col">
            <q-input
              filled
              v-model="data.admin.default_wallet_name"
              label="Default wallet name"
              hint="Default name for wallets generated without being named"
            ></q-input>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <q-input
              filled
              class="q-pr-md"
              v-model="data.admin.data_folder"
              label="Data folder"
              hint="Where your databases will be saved"
            ></q-input>
          </div>
          <div class="col">
            <q-select
              filled
              v-model="data.admin.disabled_ext"
              multiple
              hint="Disable extensions *amilk disabled by default as resource heavy"
              :options="options"
              label="Disable extensions"
            ></q-select>
          </div>
        </div>
        <br />

        <q-list bordered class="rounded-borders">
          <q-expansion-item
            expand-separator
            icon="payments"
            :label="data.admin.CLightningWallet.backend_wallet"
            @click="data.admin.CLightningWallet[7] = 1"
          >
            <q-card>
              <q-card-section>
                <q-input
                  filled
                  v-model="data.admin.CLightningWallet.endpoint"
                  label="GRPC Endpoint"
                  class="q-pr-md"
                  hint="ie /home/bob/.lightning/bitcoin/lightning-rpc"
                ></q-input>
              </q-card-section>
            </q-card>
          </q-expansion-item>

          <q-expansion-item
            expand-separator
            icon="payments"
            :label="data.admin.SparkWallet.backend_wallet"
            @click="data.admin.SparkWallet[7] = 1"
          >
            <q-card>
              <q-card-section>
                <div class="row">
                  <div class="col">
                    <q-input
                      filled
                      v-model="data.admin.SparkWallet.endpoint"
                      label="LND REST Endpoint"
                      class="q-pr-md"
                      hint="ie http://localhost:9737/rpc"
                    ></q-input>
                  </div>
                  <div class="col"></div>
                </div>
                <div class="row">
                  <div class="col">
                    <q-input
                      filled
                      v-model="data.admin.SparkWallet.admin_key"
                      label="Access token"
                      class="q-pr-md"
                      hint="Your access token"
                    ></q-input>
                  </div>
                  <div class="col"></div>
                </div>
              </q-card-section>
            </q-card>
          </q-expansion-item>

          <q-expansion-item
            expand-separator
            icon="payments"
            :label="data.admin.LndRestWallet.backend_wallet"
            @click="data.admin.LndRestWallet[7] = 1"
          >
            <q-card>
              <q-card-section>
                <div class="row">
                  <div class="col">
                    <q-input
                      filled
                      v-model="data.admin.LndRestWallet.endpoint"
                      label="LND REST Endpoint"
                      class="q-pr-md"
                      hint="default 127.0.0.1"
                    ></q-input>
                  </div>
                  <div class="col"></div>
                </div>
                <div class="row">
                  <div class="col">
                    <q-input
                      filled
                      v-model="data.admin.LndRestWallet.cert"
                      label="LND self-signed cert"
                      class="q-pr-md"
                      hint="Location of your ssl cert"
                    ></q-input>
                  </div>
                  <div class="col">
                    <q-input
                      filled
                      v-model="data.admin.LndRestWallet.admin_key"
                      label="LND admin macaroon"
                      class="q-pr-md"
                      hint="Your admin macaroon as hex or location"
                    ></q-input>
                  </div>
                </div>
              </q-card-section>
            </q-card>
          </q-expansion-item>

          <q-expansion-item
            expand-separator
            icon="payments"
            :label="data.admin.LndWallet.backend_wallet"
            @click="data.admin.LndWallet[7] = 1"
          >
            <q-card>
              <q-card-section>
                <div class="row">
                  <div class="col">
                    <q-input
                      filled
                      v-model="data.admin.LndWallet.endpoint"
                      label="LND GRPC Endpoint"
                      class="q-pr-md"
                      hint="default 127.0.0.1"
                    ></q-input>
                  </div>
                  <div class="col">
                    <q-input
                      filled
                      v-model="data.admin.LndWallet.port"
                      label="LND GRPC port"
                      class="q-pr-md"
                      hint="Deafault 11009"
                    ></q-input>
                  </div>
                </div>

                <div class="row">
                  <div class="col">
                    <q-input
                      filled
                      v-model="data.admin.LndWallet.cert"
                      label="LND self-signed cert"
                      class="q-pr-md"
                      hint="Location of your ssl cert"
                    ></q-input>
                  </div>
                  <div class="col">
                    <q-input
                      filled
                      v-model="data.admin.LndWallet.admin_key"
                      label="LND admin macaroon"
                      class="q-pr-md"
                      hint="Your admin macaroon as hex or location"
                    ></q-input>
                  </div>
                </div>
              </q-card-section>
            </q-card>
          </q-expansion-item>

          <q-expansion-item
            expand-separator
            icon="payments"
            :label="data.admin.LntxbotWallet.backend_wallet"
            @click="data.admin.LntxbotWallet[7] = 1"
          >
            <q-card>
              <q-card-section>
                <div class="row">
                  <div class="col">
                    <q-input
                      filled
                      v-model="data.admin.LntxbotWallet.admin_key"
                      label="Admin key"
                      class="q-pr-md"
                      hint="use /api in LNTXBOT"
                    ></q-input>
                  </div>
                  <div class="col"></div>
                </div>
              </q-card-section>
            </q-card>
          </q-expansion-item>

          <q-expansion-item
            expand-separator
            icon="payments"
            :label="data.admin.LNPayWallet.backend_wallet"
            @click="data.admin.LNPayWallet[7] = 1"
          >
            <q-card>
              <q-card-section>
                <div class="row">
                  <div class="col">
                    <q-input
                      filled
                      v-model="data.admin.LNPayWallet.cert"
                      label="API key"
                      class="q-pr-md"
                    ></q-input>
                  </div>
                  <div class="col">
                    <q-input
                      filled
                      v-model="data.admin.LNPayWallet.admin_key"
                      label="Admin key"
                      class="q-pr-md q-pb-md"
                    ></q-input>
                  </div>
                </div>
              </q-card-section>
            </q-card>
          </q-expansion-item>

          <q-expansion-item
            expand-separator
            icon="payments"
            :label="data.admin.LnbitsWallet.backend_wallet"
            @click="data.admin.LnbitsWallet[7] = 1"
          >
            <q-card>
              <q-card-section>
                <div class="row">
                  <div class="col">
                    <q-input
                      filled
                      v-model="data.admin.LnbitsWallet.endpoint"
                      label="LNbits endpoint"
                      class="q-pr-md"
                      hint="ie https://lnbits.com, default 127.0.0.1"
                    ></q-input>
                  </div>
                  <div class="col"></div>
                </div>
                <div class="row">
                  <div class="col">
                    <q-input
                      filled
                      v-model="data.admin.LnbitsWallet.admin_key"
                      label="Admin key"
                      class="q-pr-md q-pb-md"
                    ></q-input>
                  </div>
                  <div class="col"></div>
                </div>
              </q-card-section>
            </q-card>
          </q-expansion-item>

          <q-expansion-item
            expand-separator
            icon="payments"
            :label="data.admin.OpenNodeWallet.backend_wallet"
            @click="data.admin.OpenNodeWallet[7] = 1"
          >
            <q-card>
              <q-card-section>
                <div class="row">
                  <div class="col">
                    <q-input
                      filled
                      v-model="data.admin.OpenNodeWallet.admin_key"
                      label="Admin key"
                      class="q-pr-md"
                    ></q-input>
                  </div>
                  <div class="col"></div>
                </div>
              </q-card-section>
            </q-card>
          </q-expansion-item> </q-list
        ><br />
        <q-select
          outlined
          v-model="data.admin.funding_source_primary"
          style="max-width: 300px"
          class="q-pr-md"
          label="Select main funding source"
          :options="data.funding_source"
          label="Outlined"
        ></q-select
        ><br />
        <div>
          <q-btn label="Update" type="submit" color="primary"></q-btn>
        </div>
      </q-form>
    </q-card>
  </div>

  <div class="col-4">
    <q-card class="q-mr-md">
      <q-form class="q-px-md q-py-md" @submit="topupWallet">
        <div class="text-h6" class="q-px-md">Wallet topup</div>
        <div class="row">
          <div class="col-8">
            <q-input
              type="text"
              filled
              v-model="wallet.id"
              label="Wallet ID"
              class="q-pr-md"
              hint="Use the wallet ID to topup any wallet"
            ></q-input>
          </div>
          <div class="col-4">
            <q-input
              type="number"
              filled
              v-model="wallet.data.amount"
              label="Topup amount"
            ></q-input>
          </div>
        </div>
        <div>
          <q-btn
            class="q-ml-md"
            label="Topup"
            type="submit"
            color="deep-purple"
          ></q-btn>
        </div>
      </q-form>
    </q-card>
  </div>
</div>

{% endblock %} {% block scripts %} {{ window_vars(user) }}
<script>
  const queryString = window.location.search
  const urlParams = new URLSearchParams(queryString)
  const usr = urlParams.get('usr')
  new Vue({
    el: '#vue',
    mixins: [windowMixin],
    data: function () {
      return {
        wallet: {data: {}},
        cancel: {},
        data: {
          funding_source: [
            'CLightningWallet',
            'LndRestWallet',
            'LndWallet',
            'LntxbotWallet',
            'LNPayWallet',
            'LnbitsWallet',
            'OpenNodeWallet'
          ],

          admin: {
            site_title: 'LNbits',
            tagline: 'Free and open source wallet system',
            funding_source_primary: '',
            funding_source_edited: '',
            service_fee: 0,
            disabled_ext: '',
            edited: [],
            senddata: {}
          }
        },

        options: [
          'bleskomat',
          'captcha',
          'events',
          'example',
          'livestream',
          'lndhub',
          'lnurlp',
          'offlineshop',
          'paywall',
          'splitpayments',
          'subdomains',
          'tpos',
          'usermanager',
          'watchonly',
          'withdraw',
          'copilot',
          'hivemind',
          'jukebox',
          'lnticket',
          'ngrok',
          'amilk'
        ]
      }
    },
    created: function () {
      var self = this
      if (usr != null) {
        self.cancel.on = true
      }
      self.data.admin.user = '{{ user.id }}'
      self.data.admin.allowed_users = ''
      self.data.admin.site_title = '{{admin.site_title}}'
      self.data.admin.tagline = '{{admin.tagline}}'
      self.data.admin.service_fee = parseInt('{{admin.service_fee}}')
      self.data.admin.default_wallet_name = '{{admin.default_wallet_name}}'
      self.data.admin.data_folder = '{{admin.data_folder}}'
      self.data.admin.funding_source_primary = '{{admin.funding_source}}'
      self.data.admin.disabled_ext = '{{admin.disabled_ext}}'.split(',')
      funding = JSON.parse(String('{{ funding  | tojson|safe }}'))
      var i
      for (i = 0; i < funding.length; i++) {
        self.data.admin[funding[i].backend_wallet] = funding[i]
      }
      console.log(self.data.admin)
    },
    methods: {
      topupWallet: function () {
        var self = this
        LNbits.api
          .request(
            'POST',
            '/admin/api/v1/admin/' + self.wallet.id,
            self.g.user.wallets[0].adminkey,
            self.wallet.data
          )
          .then(function (response) {
            self.$q.notify({
              type: 'positive',
              message:
                'Success! Added ' +
                self.wallet.amount +
                ' to ' +
                self.wallet.id,
              icon: null
            })
          })

          .catch(function (error) {
            LNbits.utils.notifyApiError(error)
          })
      },

      createWallet: function () {
        LNbits.href.createWallet(this.walletName)
      },
      addSource: function (source) {
        var self = this
        self.data.admin.edited.push(source)
        console.log(self.data.admin.edited)
      },
      LaunchLNbits: function () {
        var self = this
        var data = self.data
        data.admin.senddata.site_title = data.admin.site_title
        data.admin.senddata.tagline = data.admin.tagline
        data.admin.senddata.funding_source_primary =
          data.admin.funding_source_primary
        data.admin.senddata.funding_source_edited =
          data.admin.funding_source_edited
        data.admin.senddata.allowed_users = data.admin.allowed_users
        data.admin.senddata.data_folder = data.admin.data_folder
        data.admin.senddata.default_wallet_name = data.admin.default_wallet_name
        data.admin.senddata.user = data.admin.user
        data.admin.senddata.disabled_ext = data.admin.disabled_ext.toString()
        data.admin.senddata.service_fee = parseInt(data.admin.service_fee)
        data.admin.senddata.edited = data.admin.edited.toString()
        data.admin.senddata.CLightningWallet = data.admin.CLightningWallet.toString()
        data.admin.senddata.LndRestWallet = data.admin.LndRestWallet.toString()
        data.admin.senddata.LndWallet = data.admin.LndWallet.toString()
        data.admin.senddata.LntxbotWallet = data.admin.LntxbotWallet.toString()
        data.admin.senddata.LNPayWallet = data.admin.LNPayWallet.toString()
        data.admin.senddata.LnbitsWallet = data.admin.LnbitsWallet.toString()
        data.admin.senddata.OpenNodeWallet = data.admin.OpenNodeWallet.toString()
        LNbits.api
          .request('POST', '/api/v1/admin', 'wallet.inkey', data.admin.senddata)
          .then(function (response) {
            self.$q.notify({
              type: 'positive',
              message: 'Updated',
              icon: 'thumb_up'
            })
          })
          .catch(function (error) {
            LNbits.utils.notifyApiError(error)
          })
      },

      processing: function () {
        this.$q.notify({
          timeout: 0,
          message: 'Processing...',
          icon: null
        })
      }
    }
  })
</script>
{% endblock %}
